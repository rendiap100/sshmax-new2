#!/bin/bash

RED='\033[0;31m'
NC='\033[0m'
Lgreen='\033[92m'
PURPLE='\033[35m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'

# File tempat informasi akun SSH disimpan
DB_FILE="/etc/ssh/.ssh.db"

# Cek apakah file ada
if [ ! -f "$DB_FILE" ]; then
  echo "File $DB_FILE tidak ditemukan!"
  exit 1
fi

# Mendapatkan IP
MYIP=$(wget -qO- ipinfo.io/ip)
clear
echo -e "${Lgreen}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"
echo "      PENGGUNA          DATA EXP          "
echo -e "${Lgreen}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"
echo -e "${PURPLE}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"

# Tampilkan daftar pengguna dari file .ssh.db
clients=$(grep "^#ssh#" "$DB_FILE" | cut -d' ' -f2)

# Cek apakah ada pengguna yang ditemukan
if [ -z "$clients" ]; then
  echo "Tidak ada akun SSH yang ditemukan di $DB_FILE"
  exit 1
fi

# Menampilkan daftar akun dengan penomoran
echo "$clients" | nl -s ') '

# Jumlah total akun yang ditemukan
NUMBER_OF_CLIENTS=$(echo "$clients" | wc -l)

# Meminta pengguna memilih akun
read -rp "Pilih akun SSH [1-${NUMBER_OF_CLIENTS}]: " CLIENT_NUMBER

# Validasi input
if [[ -z "$CLIENT_NUMBER" ]]; then
    echo "Tidak ada pilihan yang dimasukkan, keluar."
    exit 0
fi

if ! [[ "$CLIENT_NUMBER" =~ ^[0-9]+$ ]] || [[ "$CLIENT_NUMBER" -lt 1 ]] || [[ "$CLIENT_NUMBER" -gt "$NUMBER_OF_CLIENTS" ]]; then
    echo "Input tidak valid. Kembali ke menu SSH..."
    exit 1
fi

# Menampilkan informasi akun SSH yang dipilih
SELECTED_CLIENT=$(echo "$clients" | sed -n "${CLIENT_NUMBER}p")
echo "------------------------------"
echo "Informasi Akun SSH:"
grep "^#ssh# $SELECTED_CLIENT" "$DB_FILE"
echo "------------------------------"

# Tanya apakah ingin menampilkan isi akun secara detail
read -rp "Apakah Anda ingin melihat informasi lengkap akun ini? [y/N]: " VIEW_CONFIRMATION

if [[ "$VIEW_CONFIRMATION" =~ ^[Yy]$ ]]; then
  echo "Detail akun untuk $SELECTED_CLIENT:"
  grep "^#ssh# $SELECTED_CLIENT" "$DB_FILE"
  echo "------------------------------"
else
  echo "Tidak ada informasi detail yang ditampilkan."
fi

# Tanya apakah ingin menghapus akun
read -rp "Apakah Anda ingin menghapus akun ini? [y/N]: " DELETE_CONFIRMATION

if [[ "$DELETE_CONFIRMATION" =~ ^[Yy]$ ]]; then
  # Hapus baris akun dari file .ssh.db
  sed -i "/^#ssh# $SELECTED_CLIENT/d" "$DB_FILE"
  if [ $? -eq 0 ]; then
    echo "Akun SSH $SELECTED_CLIENT berhasil dihapus."
  else
    echo "Gagal menghapus akun SSH $SELECTED_CLIENT."
  fi
else
  echo "Akun SSH tidak dihapus."
fi

# Hitung jumlah total akun
JUMLAH="$(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd | wc -l)"
echo -e "${PURPLE}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"
echo -e "${Lgreen}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"
echo -e "     Jumlah akun: $JUMLAH user"
echo -e "${Lgreen}◈━━━━━━━━━━━━━━━━━◈◈━━━━━━━━━━━━━━━━━◈ ${NC}"
echo -e ""
read -n 1 -s -r -p "ENTER UNTUK KEMBALI KE MENU"
m-sshws
