#!/bin/bash

# File tempat akun SSH disimpan
DB_FILE="/etc/ssh/.ssh.db"

# Cek apakah file ada
if [ ! -f "$DB_FILE" ]; then
  echo "File $DB_FILE tidak ditemukan!"
  exit 1
fi

clear
echo "TAMPILKAN INFORMASI AKUN SSH"
echo "Silakan pilih akun yang ingin ditampilkan atau dihapus"
echo "==============================="

# Mengambil semua akun ssh yang dimulai dengan "#ssh#"
clients=$(grep "^#ssh#" "$DB_FILE" | cut -d' ' -f2)

# Cek apakah ada akun yang ditemukan
if [ -z "$clients" ]; then
  echo "Tidak ada akun SSH yang ditemukan di $DB_FILE"
  exit 1
fi

# Menampilkan daftar akun dengan penomoran
echo "$clients" | nl -s ') '

# Jumlah total akun yang ditemukan
NUMBER_OF_CLIENTS=$(echo "$clients" | wc -l)

# Meminta pengguna memilih akun
read -rp "Pilih akun SSH [1-${NUMBER_OF_CLIENTS}]: " CLIENT_NUMBER

# Validasi input
if [[ -z "$CLIENT_NUMBER" ]]; then
    echo "Tidak ada pilihan yang dimasukkan, keluar."
    exit 0
fi

if ! [[ "$CLIENT_NUMBER" =~ ^[0-9]+$ ]] || [[ "$CLIENT_NUMBER" -lt 1 ]] || [[ "$CLIENT_NUMBER" -gt "$NUMBER_OF_CLIENTS" ]]; then
    echo "Input tidak valid. Kembali ke menu SSH..."
    exit 1
fi

# Menampilkan informasi akun SSH yang dipilih
SELECTED_CLIENT=$(echo "$clients" | sed -n "${CLIENT_NUMBER}p")
echo "------------------------------"
echo "Informasi Akun SSH:"
grep "^#ssh# $SELECTED_CLIENT" "$DB_FILE"
echo "------------------------------"

# Tanya apakah ingin menghapus akun
read -rp "Apakah Anda ingin menghapus akun ini? [y/N]: " DELETE_CONFIRMATION

if [[ "$DELETE_CONFIRMATION" =~ ^[Yy]$ ]]; then
  # Hapus baris akun dari file .ssh.db
  sed -i "/^#ssh# $SELECTED_CLIENT/d" "$DB_FILE"
  if [ $? -eq 0 ]; then
    echo "Akun SSH $SELECTED_CLIENT berhasil dihapus."
  else
    echo "Gagal menghapus akun SSH $SELECTED_CLIENT."
  fi
else
  echo "Akun SSH tidak dihapus."
fi
